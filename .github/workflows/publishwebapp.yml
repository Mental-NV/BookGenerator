name: publish pipeline

on: [push]

jobs:
  build-test-deploy:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: ['8.0.x']
        node-version: [18.x]

    steps:
      - uses: actions/checkout@v3
  
      - name: Setup .NET Core SDK ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Install dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Test
        run: dotnet test --no-restore --verbosity normal

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
            node-version: ${{ matrix.node-version }}

      - name: Install NPM dependencies
        run: npm ci
        working-directory: ./src/BookGenerator.ClientSpa/ClientApp

      - name: Build NPM
        run: npm run build
        working-directory: ./src/BookGenerator.ClientSpa/ClientApp

      - name: Run tests
        run: npm run test
        working-directory: ./src/BookGenerator.ClientSpa/ClientApp
        
      - name: Publish WebApi
        run: dotnet publish -c Release -o Publish
        working-directory: ./src/BookGenerator.WebApi

      - name: Publish WebAPP
        run: dotnet publish -c Release -o Publish
        working-directory: ./src/BookGenerator.Client

      - name: Publish WebAPP SPA
        run: dotnet publish -c Release -o Publish
        working-directory: ./src/BookGenerator.ClientSpa

      - name: Deploy WebApi
        uses: azure/webapps-deploy@v2
        with:
          app-name: BookGeneratorApi
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_WEBAPI }}
          package: './src/BookGenerator.WebApi/Publish'

      - name: Deploy WebApp
        uses: azure/webapps-deploy@v2
        with:
          app-name: BookGenerator
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_WEBAPP }}
          package: './src/BookGenerator.ClientSpa/Publish'
      
      - name: Install Bruno CLI
        run: npm install -g @brunocli/bruno-cli

      - name: Run Bruno integration tests
        run: bru run
        working-directory: ./tests/Bruno/BookGenerator
        continue-on-error: true

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Bruno API tests have failed',
              issue_number: context.payload.pull_request ? context.payload.pull_request.number : context.run_id,
              body: '⚠️ Bruno API tests have failed. Please check the logs.'
            })
        
